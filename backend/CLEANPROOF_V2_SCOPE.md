# CleanProof V2 — Product & Architecture Scope

Документ описывает, **что такое V2 для CleanProof**, в чём он отличается от V1  
и какие направления развития считаются приоритетными.

Это **не техническая спецификация задач**, а опорный документ:  
по нему можно собирать PRD, бэклог и архитектурные решения.

---

## 0. Связь с V1

### V1 — что уже есть

На момент старта V2:

- execution-ядро **реально работает**:
  - Jobs: статусы `scheduled → in_progress → completed`;
  - GPS check-in / check-out + distance validation;
  - proof: before/after photos, checklist, audit trail через `JobCheckEvent`.
- SLA-слой функционирует:
  - issue rate, violations count;
  - top SLA reasons, топовые локации и клинеры.
- Reports:
  - weekly / monthly отчёты;
  - PDF-генерация;
  - email-рассылка;
  - Owner overview в UI как in-app dashboard.
- Evidence:
  - Reports → Violations → Jobs → Job details / JobSidePanel;
  - связка до реальных доказательств (фото, чек-лист, события).

V1 уже можно демить как работающий продукт.

### V2 — зачем нужен

V2 не про «больше экранов».  
**V2 = убираем ограничения V1, делаем продукт масштабируемым и удобным для сетей 50–100+ локаций.**

Основные цели V2:

1. Сделать execution слой устойчивым к реальным условиям (оффлайн, сбои, сложные политики).
2. Расширить SLA/Evidence так, чтобы можно было защищать решения перед владельцем/клиентом.
3. Вывести аналитику из “оперативных отчётов” в полноценный, но не перегруженный Analytics-слой.
4. Добавить коммерческий скелет (тарифы, лимиты, роли) без избыточной сложности.
5. Подготовить платформу к enterprise-клиентам через audit, versioning и согласованную модель данных.

---

## 1. Принципы V2

1. **Evolution, not rewrite**
   - Никаких «переписать всё с нуля».
   - V2 — надстройка над V1, максимально reuse существующих сущностей.

2. **Backend = source of truth**
   - Все правила, политики, расчёты — на стороне backend.
   - Frontend только отображает и оркестрирует UX.

3. **Один слой за раз**
   - Работы по V2 разбиваются по слоям (Execution / SLA / Analytics / Commerce / Platform).
   - В каждом слое: сначала закрываем минимальный вертикальный срез, потом расширяем.

4. **Ограничения лучше, чем хаос**
   - Лучше иметь меньше функций, но с ясной семантикой и предсказуемым поведением,
     чем “много галочек, но всё ведёт себя странно”.

5. **Analytics API определяет факты. SLA/Reports определяют интерпретацию.**
   - Analytics — источник метрик.
   - SLA и Reports — разные “линзы” на эти метрики для разных ролей.

---

## 2. Пилон V2.1 — Execution & Mobile (Offline-first, Proof Policies)

### 2.1. Цель

**Сделать выполнение работ устойчивым и предсказуемым даже при плохой связи,  
и не завязать всю архитектуру навсегда на текущий UX.**

Сегодня:
- мобильный клиент строго требует before/after и чек-лист;
- кнопка complete неактивна без proof;
- всё хорошо, пока есть сеть и UX не меняется.

Задача V2 — подготовиться к будущему, где:
- будет оффлайн;
- появится возможность “форснуть complete” из веба;
- для части задач фото могут быть опциональными.

### 2.2. Offline-first execution (минимальный, но реальный)

#### Семантика

Вводим явные состояния синхронизации для мобильных действий:

- `pending_sync` — событие создано на устройстве, не подтверждено сервером;
- `synced` — событие успешно записано на сервер;
- `sync_failed` — попытка отправки не удалась, нужен retry.

Эти состояния могут относиться к:

- check-in / check-out,
- загрузке фото,
- чек-листу,
- переводу job в `completed`.

#### Требования к UX

- Клинер **явно видит**, что:
  - job “ожидает отправки”,
  - всё синхронизировано,
  - есть ошибки и их можно повторить.
- Никаких “тихих фейлов”:
  - если фото не ушло — это видно,
  - если чек-лист не записался — это видно.

#### Требования к backend

- Возможность принимать события “задним числом” с метаданными:
  - `created_at` (на устройстве),
  - `received_at` (на сервере).
- Чёткие правила:
  - как считать фактическое время выполнения при оффлайне;
  - как разрешать конфликты, если одно и то же действие отправлено дважды.

---

### 2.3. Flexible proof policies

#### Проблема V1

Сейчас logic примерно:

> “Всегда нужны before & after & checklist”.

V2 должен позволить конфигурировать:

- где фото обязательны;
- где только after;
- где чек-лист обязателен;
- где достаточно одного фото.

#### Уровни политики

Минимум:

1. **На уровне компании**
   - глобальная политика по умолчанию:
     - required: before/after/checklist (true/false).

2. **На уровне локации**
   - переопределение политики:
     - “в этой локации достаточно after-only”.

3. **(Опционально позже) На уровне типа job**
   - например, deep clean vs regular cleaning.

#### Взаимодействие с SLA

- `missing_before_photo`, `missing_after_photo`, `checklist_not_completed`
  остаются **универсальными reason code**.
- Политика отвечает на вопрос:
  > “Считается ли отсутствие before-фото нарушением для этой job?”
- SLA engine должен учитывать:
  - policy для конкретной job;
  - фактические события (фото/чек-лист).

---

### 2.4. Mobile UX reliability

#### Задачи

1. Ясное состояние job:
   - не только `scheduled/in_progress/completed`,
   - но и:
     - “в процессе выгрузки”,
     - “нужны фото”,
     - “нужен чек-лист”.

2. Ошибки:
   - единый стиль сообщений;
   - минимизация технических формулировок;
   - явные кнопки “повторить” / “обновить”.

3. Валидация на клиенте:
   - не позволять отправлять пустые данные;
   - однако **все критичные проверки — на backend**, чтобы не было расхождений.

---

## 3. Пилон V2.2 — SLA & Evidence v2

### 3.1. Цель

**Сделать Evidence-слой таким, чтобы он выдерживал:**

- спор с клиентом,
- внутреннюю проверку качества,
- рост числа job и пользователей.

### 3.2. Расширение типов SLA-нарушений (не ломая существующие)

Сейчас основные reasons связаны с proof (фото/чек-лист).

В V2 добавляем новые категории, например:

- `late_start` — job начата позже планового времени;
- `late_finish` — job завершена позже планового конца (с учётом политики);
- `frequent_cancellation` — высокий процент отмен в локации/по клинеру;
- `gps_mismatch_minor` / `gps_mismatch_major` — серьёзность отклонения.

#### Требования

- Каждому reason:
  - чёткое текстовое объяснение для владельца;
  - понятный mapping на события и поля:
    - `actual_start`, `actual_end`,
    - `scheduled_start`, `scheduled_end`,
    - GPS-координаты,
    - события отмены.

- Новые reasons добавляются **расширением**, а не изменением семантики старых.

---

### 3.3. Evidence timeline

#### Идея

Для каждой job хотим видеть **ленточку событий**:

- planned: `scheduled_start/end`;
- events:
  - check-in (время, координаты);
  - фото (before/after, кто сделал, когда, GPS);
  - checklist completed (кто, когда);
  - check-out / completed.

#### Зачем

- Это “история” job, которую можно показать:
  - владельцу,
  - клиенту,
  - внутреннему аудитору.
- Позволяет:
  - быстро понять, что реально происходило;
  - защищать доказательства в спорных ситуациях.

#### Требования к реализации

- Использовать уже существующий `JobCheckEvent` как основу:
  - при необходимости расширить типы событий;
  - **не плодить новые сущности без нужды**.
- UI:
  - компактный timeline в Job details;
  - опционально — развёрнутый Evidence view.

---

## 4. Пилон V2.3 — Reports & Analytics

### 4.1. Unified Analytics page

Сейчас:

- есть Reports (weekly/monthly);
- есть SLA Performance / Violations;
- задуман Analytics API v1 (семантика).

В V2 задача:

> Сделать единый **Analytics**-слой, который станет фактическим источником данных  
> для Reports, SLA Performance и новых графиков.

#### Структура будущей Analytics-страницы (пример)

- **Overview**
  - KPI за выбранный период:
    - jobs completed;
    - issue rate;
    - proof completion;
    - on-time completion;
    - issues detected.
- **Trends**
  - jobs completed over time;
  - average job duration;
  - proof completion trend (before/after/checklist).
- **Cleaners**
  - performance по клинерам;
  - таблица + простой график.
- **Locations**
  - аналогично, по локациям.

#### Связь с Analytics API v1

Analytics API:

- определяет **формат и семантику** данных;
- работает как единый слой для:
  - Analytics UI;
  - Reports (могут переехать на этот API);
  - SLA Performance (может переиспользовать часть агрегатов).

---

### 4.2. Custom periods & comparisons

Для V2 важно позволить менеджеру и владельцу смотреть:

- **произвольные периоды** (не только week/month),
- **сравнения**:
  - this month vs previous month;
  - this location vs company average;
  - этот клинер vs median.

Ограничения:

- делаем это **после** того, как базовый Analytics API и UI готовы;
- не перегружаем интерфейс — первые версии сравнения могут быть:
  - simple: “+X% vs previous period”,
  - без сложных графиков.

---

## 5. Пилон V2.4 — Commerce & Roles

### 5.1. План/тарифная модель

#### Цели

- Сформировать **коммерческий скелет**:
  - планы,
  - лимиты,
  - trial/paid-состояния.

#### Модель

Сущность `Plan` (или аналог):

- параметры:
  - `max_jobs_per_month` (или per период);
  - `max_locations`;
  - `max_cleaners`;
  - другие лимиты (по мере необходимости).
- флаги:
  - `is_trial`;
  - `is_default_for_new_company`.

Связь с `Company`:

- у компании ровно один активный план;
- есть информация о:
  - дате начала trial;
  - дате окончания trial (если есть);
  - статусе: active / trial_expired / suspended.

---

### 5.2. Enforcement лимитов

V2 не обязан сразу блокировать всё “в лоб”:

- первый шаг — **soft enforcement**:
  - предупреждения в UI;
  - явные сообщения при попытке выйти за лимит.

Возможные сценарии:

- компания превысила `max_jobs_per_month`:
  - блокируем создание новых jobs;
  - показываем понятное сообщение;
  - даём ссылку на Billing/Plans страницу.

Все правила enforcement должны быть:

- задокументированы в `API_CONTRACTS.md` и `MASTER_BRIEF.md`;
- реализованы **на backend**, UI только показывает сообщения.

---

### 5.3. Multi-role access

#### Цель

Отделить:

- **owner** — стратегический взгляд, финансы, общий SLA;
- **manager** — операционное управление job’ами;
- **supervisor** — локальный контроль локации/команды;
- **cleaner** — ограниченный доступ (свой график, своя история).

V2:

- не обязательно сразу реализовывать все роли,
- важно **заложить модель**, где:
  - права завязаны на роль + company;
  - каждый endpoint знает, кому он доступен.

---

## 6. Пилон V2.5 — Platform & Security

### 6.1. Audit & экспорт

#### Audit

Уже есть:

- `JobCheckEvent`;
- `ReportEmailLog`.

В V2:

- формализовать, какие действия считаются **аудируемыми**:
  - изменение статуса job;
  - override SLA;
  - ручная правка времени выполнения;
  - смена планов/лимитов.

Для этих действий:

- обязателен trace:
  - кто,
  - когда,
  - что именно изменил.

#### Экспорт

- Минимум: CSV / JSON-экспорт ключевых отчётов для owner-level:
  - jobs + SLA flags;
  - aggregated SLA per period;
  - proof-completion статистика.

---

### 6.2. API versioning & stability

#### Принципы

- `v1` — всё, что уже есть сейчас;
- V2-изменения:
  - по возможности backward-compatible;
  - если breaking — явная пометка v2.

Примеры правил:

- можно добавлять новые поля в ответы v1;
- нельзя:
  - менять семантику существующих полей;
  - удалять обязательные поля.

Если требуется серьёзный пересмотр — создаём:

- новый endpoint (`/v2/...` или `.../v2/`);
- новую секцию в `API_CONTRACTS.md` с пометкой v2.

---

## 7. Что НЕ входит в V2 (осознанно)

Чтобы не размазать фокус, явно фиксируем, чего **нет** в V2:

- ❌ marketplace клинеров (агрегатор чужих подрядчиков);
- ❌ “no-code workflow builder” для собственных сценариев;
- ❌ “AI ради AI”:
  - автогенерация отчётов без понятных исходных метрик;
  - “smart suggestions”, не подкреплённые фактами;
- ❌ real-time streaming dashboards:
  - V2 достаточно обновления по запросу / периодически.

Эти темы — либо V3, либо отдельный продукт.

---

## 8. Как использовать этот документ

1. **Для PRD:**  
   - по каждому пилону (Execution / SLA / Analytics / Commerce / Platform)
     собирать отдельный PRD, ссылаясь на соответствующие разделы этого файла.

2. **Для планирования:**  
   - приоритизировать:
     - сначала V2.1 (Execution & Mobile),
     - затем V2.4 (Commerce skeleton),
     - потом V2.3 (Analytics реализация),
     - параллельно — точечные улучшения SLA & Evidence.

3. **Для общения с разработчиками / партнёрами:**  
   - показывать как “источник правды” по тому, что вообще включено в V2,
     а что точно **не делаем** на этом этапе.

---
